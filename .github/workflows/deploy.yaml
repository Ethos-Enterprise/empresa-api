name: Deploy to EC2
on:
  workflow_run:
    workflows: [ "Docker Image CI" ]
    types:
      - completed

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Copy SSH key
        uses: webfactory/ssh-agent@v0.5.3
        with:
          ssh-private-key: ${{ secrets.EC2_SSH_KEY }}

      - name: Deploy to EC2 instance 1
        run: |
          ssh -t -o StrictHostKeyChecking=no ubuntu@44.198.241.238 << 'EOF'
            ssh-keygen -f "/home/ubuntu/.ssh/known_hosts" -R "10.0.0.171"
            ssh -t -i /home/ubuntu/.ssh/ethos.pem -o StrictHostKeyChecking=no ubuntu@10.0.0.171 << 'INNER_EOF'
              cd docker-compose-ethos
              docker-compose -f stack.yaml pull
              docker-compose -f stack.yaml up -d
          INNER_EOF
          EOF

      - name: Deploy to EC2 instance 2
        run: |
          ssh -t -o StrictHostKeyChecking=no ubuntu@44.198.241.238 << 'EOF'
            ssh-keygen -f "/home/ubuntu/.ssh/known_hosts" -R "10.0.0.159"
            ssh -t -i /home/ubuntu/.ssh/ethos.pem -o StrictHostKeyChecking=no ubuntu@10.0.0.159 << 'INNER_EOF'
              cd docker-compose-ethos
              docker-compose -f stack.yaml pull
              docker-compose -f stack.yaml up -d
          EOF